<!DOCTYPE html>
<html>
<head>
<style>
* {
    margin:0;
    padding:0;
}

.cell {
    width: 16px;
    height: 16px;
    background-image: url(./tileset1.png);
    background-position-x: calc(var(--index)*-16px);
}

input[type=checkbox] {
    display:none;
}
input[type=checkbox] + label {
    opacity: 50%;
    display:inline-block;
    width: 16px;
    height: 16px;
    margin:24px;
    background-image: url(./tileset1.png);
    background-position-x: calc(var(--index)*-16px);
    border-bottom-style: solid;
    border-bottom-width: 2px;
    border-bottom-color: #fff;
    scale:4;
}
input[type=checkbox]:checked + label {
    opacity: 100%;
    border-bottom-color: #222;
}

input[type=radio] {
    display:none;
}
input[type=radio] + label {
    opacity: 50%;
    display:inline-block;
    width: 16px;
    height: 16px;
    margin:24px;
    background-image: url(./tileset1.png);
    background-position-x: calc(var(--index)*-16px);
    border-bottom-style: solid;
    border-bottom-width: 2px;
    border-bottom-color: #fff;
    scale:4;
}
input[type=radio]:checked + label {
    opacity: 100%;
    border-bottom-color: #222;
}
</style>
</head>
<body>

<form action="javascript:void(0);">
<div id="which-panel"></div>
<div id="panels"></div>
<input type="text" id="output-code" />
<input type="button" id="reroll" value="Reroll" />
</form>

<script>
const numTiles = 14;
const ALL = (1<<numTiles)-1;
const _state = [];
// We keep track of the relative time in which states are collapsed since this
// is super useful for working out what happened when things go wrong.
const _times = [];
let _counter = 0;
let _resetme = true;

let previousPanelIndex = 0;

// Create the radio buttons which control which panel to show. Each button is a
// tile from the palette.
const whichPanel = document.getElementById("which-panel");
for (let panelIndex = 0; panelIndex < numTiles; panelIndex++) {
    const radiobutton = document.createElement("input");
    radiobutton.type = "radio";
    radiobutton.name = "which-panel";
    radiobutton.id = `which-${panelIndex}`;
    radiobutton.checked = panelIndex==0;
    whichPanel.appendChild(radiobutton);

    const label = document.createElement("label");
    label.setAttribute('for', radiobutton.id);
    label.style = `--index:${panelIndex}`;
    whichPanel.appendChild(label);

    radiobutton.addEventListener("change", (e)=> {
        const prevPanel = document.getElementById(`${previousPanelIndex}-panel`);
        const curPanel = document.getElementById(`${panelIndex}-panel`);

        prevPanel.style.display = "none";
        curPanel.style.display = "block";
        previousPanelIndex = panelIndex;
    });
}

// Create a panel for each tile. Each panel is revealed by a radio button (see
// above). The panel contains the constraints for each cardinal adjacency: up,
// left, right, down, each of which has a list of checkboxes for each tile in
// the palette. If the checkbox is checked this indicates the tile is allowed
// in that direction.
//
// For example:
//  __panel_1_______
// / up: [1,3]
// | down: [2]
// | left: [1]
// | right: [1]
//
// Here tile 1 is allowed to have tiles 1 and 3 above it, and tile 2 below it,
// and can only neighbor other tiles 1 to the right and left.
const outputCode = document.getElementById("output-code");
const panels = document.getElementById("panels");
for (let panelIndex = 0; panelIndex < numTiles; panelIndex++) {
    const panel = document.createElement("div");
    panel.id = `${panelIndex}-panel`;
    panel.style.display = (panelIndex==0)? "block":"none";
    for (const direction of ["right","down"]) {
        const fieldset = document.createElement("fieldset");
        const label = document.createElement("label");
        label.innerText = direction;
        fieldset.appendChild(label);

        for (let tileIndex = 0; tileIndex < numTiles; tileIndex++) {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `${panelIndex}-${direction}-${tileIndex}`;
            fieldset.appendChild(checkbox);

            const label1 = document.createElement("label");
            label1.setAttribute("for", checkbox.id);
            label1.style = `--index:${tileIndex}`;
            fieldset.appendChild(label1);


            checkbox.addEventListener("change", (e)=> {
                _constraints = produceConstraints();
                outputCode.value = JSON.stringify(_constraints);
            });
        }
        panel.appendChild(fieldset);
    }
    document.body.appendChild(panel);
}

// Given the state of the interface produced above, we now need to convert the
// constraints to a form we can use.
function produceConstraints() {
    let constraints = {};
    for (const direction of ["right","down"]) {
        constraints[direction] = [];
        for (let i = 0; i < numTiles; i++) {
            constraints[direction][i] = 0;
            for (let j = 0; j < numTiles; j++) {
                const checkbox = document.getElementById(`${i}-${direction}-${j}`);
                if (checkbox.checked)
                    constraints[direction][i] |= (1<<j);
            }
        }
    }
    return constraints;
}
let _constraints = produceConstraints();
outputCode.value = JSON.stringify(_constraints);

// This does the opposite of the above method, instead we are taking the JSON
// and setting the GUI state to reflect it.
function reproduceConstraints(constraints) {
    for (const direction of ["right","down"]) {
        for (let i = 0; i < numTiles; i++) {
            for (let j = 0; j < numTiles; j++) {
                const checkbox = document.getElementById(`${i}-${direction}-${j}`);
                checkbox.checked = ((constraints[direction][i] & (1<<j)) != 0);
            }
        }
    }
}
outputCode.addEventListener("change", (e) => {
    reproduceConstraints(JSON.parse(outputCode.value));
});
reproduceConstraints(_constraints = {"right":[533,5378,8328,533,2144,532,2144,8328,532,5378,2144,5378,8328,5378],"down":[141,3138,8720,4384,141,141,141,3138,4384,8720,4384,8720,3138,3138]});

const width = 10;
const height = 10;

const tbl = document.createElement('table');
for (let y = 0; y < height; y++) {
    const tr = tbl.insertRow();
    for (let x = 0; x < width; x++) {
        const td = tr.insertCell();
        td.id = `cell-${x}-${height-y-1}`;
        td.className = 'cell';
        tr.appendChild(td);
    }
}
document.body.appendChild(tbl);



function state(x,y,value) {
    if (x < 0 || x >= width || y < 0 || y >= height)
        return ALL;
    if (value !== undefined) {
        const old = _state[y*width+x];
        _state[y*width+x] = value;
        if (old != value)
            _times[y*width+x] = _counter++;
        return old;
    }
    return _state[y*width+x];
}

function sync() {
    for (let y = 0; y < height; y++)
    for (let x = 0; x < width; x++) {
        const td = document.getElementById(`cell-${x}-${y}`);
        const s = state(x,y);
        
        if ((s & (s-1)) == 0)
            td.style = `--index:${Math.log2(s)}`;
        else
            td.style = `background:none;`;
        td.setAttribute('title', `${x},${y}:${state(x,y)};${_times[y*width+x]}`);
    }
}

function assign(x,y,val,res) {
    const S_ = state(x,y) & val;
    if (S_ == 0)
        return;
    const S = state(x,y,S_);
    if ((S & ~val) != 0 && res !== undefined)
        res.push([x,y]);
}

function collapse(x,y) {
    const choices = [];
    let S = state(x,y);
    for (let i = 0; i < numTiles; i++)
        if ((S & (1<<i)) != 0)
            choices.push(i);
    state(x,y,1<<choices[Math.floor(choices.length*Math.random())]);
}

function reset() {
    for (let i = 0; i < width*height; i++)
        _state[i] = ALL;
    for (let i = 0; i < width*height; i++)
        _times[i] = 0;
    _resetme = false;
}

function update(x,y) {
    sync();
    if (_resetme)
        reset();
    if (y < 0)
        return;
    const a = (x-1<0)? ALL : _constraints["right"][Math.log2(state(x-1,y))];
    const b = (y+1>=height)? ALL : _constraints["down"][Math.log2(state(x,y+1))];

    state(x,y, a&b);
    collapse(x,y);

    setTimeout(update, 0, (x+1)>=width?0:(x+1), (x+1)>=width?(y-1):y);
}
update(0,height-1);

const rerollButton = document.getElementById("reroll");
rerollButton.addEventListener("click", (e)=> {
    _resetme = true;
    update(0,height-1);
});
</script>



</body>
</html>